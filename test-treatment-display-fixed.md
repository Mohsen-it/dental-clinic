# إصلاح عرض العلاج المرتبط في نافذة تعديل المدفوعات

## المشكلة السابقة
عندما يضغط المستخدم على "تعديل" لدفعة مرتبطة بعلاج محدد:
- القائمة المنسدلة كانت معطلة ✅
- لكن العلاج المرتبط لم يكن ظاهراً بوضوح ❌

## الحل المُطبق

### 1. **عرض العلاج كنص ثابت بدلاً من قائمة منسدلة معطلة**

#### للمدفوعات المرتبطة بعلاج:
```typescript
{payment.tooth_treatment_id && payment.tooth_treatment_id !== 'none' ? (
  // عرض العلاج المحدد كنص ثابت
  <div className="p-3 bg-muted/50 border border-border rounded-md">
    <div className="flex items-center justify-between">
      <div className="flex flex-col">
        <span className="font-medium text-foreground">
          السن {linkedTreatment.tooth_number} - {getTreatmentNameInArabic(linkedTreatment.treatment_type)}
        </span>
        <span className="text-xs text-muted-foreground">
          التكلفة: {formatAmount(linkedTreatment.cost || 0)}
        </span>
      </div>
      <Badge variant="secondary" className="text-xs">
        مرتبط
      </Badge>
    </div>
  </div>
) : (
  // القائمة المنسدلة العادية للمدفوعات غير المرتبطة
  <Select>...</Select>
)}
```

#### للمدفوعات غير المرتبطة بعلاج:
- تظهر القائمة المنسدلة العادية
- يمكن اختيار علاج جديد

### 2. **التصميم البصري المحسن**

#### العناصر المضافة:
- **خلفية مميزة**: `bg-muted/50` لتمييز العلاج المرتبط
- **حدود واضحة**: `border border-border rounded-md`
- **شارة "مرتبط"**: `Badge` لتوضيح أن العلاج مرتبط
- **تنسيق النص**: عرض اسم العلاج والتكلفة بوضوح

### 3. **الحفاظ على البيانات عند الإرسال**

```typescript
// استخدام معرف العلاج من الدفعة الأصلية إذا كانت مرتبطة بعلاج
const treatmentId = payment.tooth_treatment_id && payment.tooth_treatment_id !== 'none' 
  ? payment.tooth_treatment_id 
  : (formData.tooth_treatment_id && formData.tooth_treatment_id !== 'none' ? formData.tooth_treatment_id : undefined)
```

## المميزات الجديدة

### 1. **وضوح بصري كامل**
- العلاج المرتبط يظهر بوضوح مع اسمه ورقم السن
- التكلفة تظهر أسفل اسم العلاج
- شارة "مرتبط" تؤكد أن هذا العلاج مرتبط بالدفعة

### 2. **منع التعديل الخاطئ**
- لا يمكن تغيير العلاج للمدفوعات المرتبطة
- رسالة تحذيرية واضحة
- الحفاظ على ربط البيانات عند الحفظ

### 3. **تجربة مستخدم محسنة**
- لا التباس حول إمكانية التعديل
- معلومات واضحة عن العلاج المرتبط
- تصميم متسق مع باقي الواجهة

## سيناريوهات الاختبار

### السيناريو 1: تعديل دفعة مرتبطة بعلاج
1. اذهب إلى صفحة المدفوعات
2. ابحث عن دفعة مرتبطة بعلاج (لها `tooth_treatment_id`)
3. اضغط على "تعديل"
4. **النتيجة المتوقعة**:
   - يظهر مربع رمادي فاتح يحتوي على معلومات العلاج
   - اسم العلاج ورقم السن واضحين
   - التكلفة تظهر أسفل اسم العلاج
   - شارة "مرتبط" في الجانب الأيمن
   - رسالة تحذيرية أسفل المربع

### السيناريو 2: تعديل دفعة غير مرتبطة بعلاج
1. اذهب إلى صفحة المدفوعات
2. ابحث عن دفعة عامة (بدون `tooth_treatment_id`)
3. اضغط على "تعديل"
4. **النتيجة المتوقعة**:
   - تظهر القائمة المنسدلة العادية
   - يمكن اختيار علاج جديد
   - لا توجد قيود على التعديل

### السيناريو 3: حفظ التعديلات
1. افتح تعديل دفعة مرتبطة بعلاج
2. عدّل المبلغ المدفوع
3. احفظ التعديلات
4. **النتيجة المتوقعة**:
   - يتم حفظ التعديلات بنجاح
   - ربط العلاج يبقى كما هو
   - لا يتم فقدان معرف العلاج

## الفوائد

### 1. **وضوح تام**
- المستخدم يرى بوضوح العلاج المرتبط بالدفعة
- لا يوجد التباس حول إمكانية التعديل
- المعلومات كاملة ومفصلة

### 2. **حماية البيانات**
- منع تعديل الروابط المهمة بالخطأ
- الحفاظ على سلامة النظام المحاسبي
- ضمان عدم فقدان ربط العلاجات بالمدفوعات

### 3. **تجربة مستخدم ممتازة**
- تصميم واضح ومفهوم
- ألوان وتنسيق متسق
- رسائل توضيحية مفيدة

## ملاحظات تقنية

### التوافق
- يعمل مع جميع أنواع المدفوعات
- لا يؤثر على الوظائف الأخرى
- متوافق مع النظام الحالي

### الأداء
- لا يؤثر على سرعة التحميل
- استخدام فعال للذاكرة
- عرض سريع للبيانات

### الأمان
- حماية من التلاعب بالبيانات
- التحقق من صحة المعرفات
- منع الأخطاء المحاسبية
