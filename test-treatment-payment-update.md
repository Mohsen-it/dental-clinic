# اختبار تحديث المدفوعات عند تعديل تكلفة العلاج

## المشكلة المُحلة
عند تعديل تكلفة علاج من صفحة العلاجات، كان يتم إنشاء سجل جديد في جدول المدفوعات بدلاً من تعديل السجل الموجود المرتبط بنفس السن والعلاج.

## الحل المُطبق
تم تحديث دالة `updatePaymentsForEditedTreatment` في ملف `src/components/dental/MultipleToothTreatments.tsx` لتقوم بـ:

1. **البحث عن جميع المدفوعات المرتبطة بالعلاج**: بدلاً من البحث عن المدفوعات المعلقة فقط
2. **تحديث المدفوعات الموجودة**: بدلاً من إنشاء مدفوعات جديدة
3. **إعادة حساب الحالات والأرصدة**: بناءً على التكلفة الجديدة

## التحسينات المُضافة

### 1. البحث الشامل عن المدفوعات
```typescript
const treatmentPayments = patientPayments.filter(payment =>
  payment.tooth_treatment_id === treatment.id
)
```

### 2. حساب الحالة الجديدة بذكاء
```typescript
let newStatus: 'completed' | 'partial' | 'pending'
if (newCost <= 0) {
  newStatus = 'completed'
} else if (remainingBalance <= 0 && totalPaidForTreatment > 0) {
  newStatus = 'completed'
} else if (totalPaidForTreatment > 0) {
  newStatus = 'partial'
} else {
  newStatus = 'pending'
}
```

### 3. تحديث جميع المدفوعات المرتبطة
```typescript
for (const payment of treatmentPayments) {
  const updatedPaymentData = {
    tooth_treatment_id: treatment.id,
    description: description,
    total_amount_due: newCost,
    remaining_balance: remainingBalance,
    treatment_total_cost: newCost,
    treatment_total_paid: totalPaidForTreatment,
    treatment_remaining_balance: remainingBalance,
    status: newStatus
  }
  await updatePayment(payment.id, updatedPaymentData)
}
```

## سيناريوهات الاختبار

### السيناريو 1: تعديل تكلفة علاج له دفعة معلقة
- **قبل**: علاج بتكلفة 100 ريال، دفعة معلقة بمبلغ 0
- **بعد التعديل**: تكلفة 150 ريال
- **النتيجة المتوقعة**: تحديث الدفعة الموجودة لتصبح التكلفة الإجمالية 150 ريال

### السيناريو 2: تعديل تكلفة علاج له دفعة جزئية
- **قبل**: علاج بتكلفة 100 ريال، دفعة جزئية بمبلغ 50 ريال
- **بعد التعديل**: تكلفة 80 ريال
- **النتيجة المتوقعة**: تحديث الدفعة الموجودة، الحالة تصبح "جزئية" والمتبقي 30 ريال

### السيناريو 3: تعديل تكلفة علاج له دفعة مكتملة
- **قبل**: علاج بتكلفة 100 ريال، دفعة مكتملة بمبلغ 100 ريال
- **بعد التعديل**: تكلفة 150 ريال
- **النتيجة المتوقعة**: تحديث الدفعة الموجودة، الحالة تصبح "جزئية" والمتبقي 50 ريال

### السيناريو 4: تعديل تكلفة علاج ليس له مدفوعات
- **قبل**: علاج بتكلفة 0 ريال، لا توجد مدفوعات
- **بعد التعديل**: تكلفة 100 ريال
- **النتيجة المتوقعة**: إنشاء دفعة معلقة جديدة بتكلفة 100 ريال

### السيناريو 5: تعديل تكلفة علاج إلى صفر
- **قبل**: علاج بتكلفة 100 ريال، دفعة جزئية بمبلغ 50 ريال
- **بعد التعديل**: تكلفة 0 ريال
- **النتيجة المتوقعة**: تحديث الدفعة الموجودة، الحالة تصبح "مكتملة"

## الفوائد
1. **منع التكرار**: لا يتم إنشاء مدفوعات مكررة
2. **دقة البيانات**: الحفاظ على تطابق البيانات بين العلاجات والمدفوعات
3. **سهولة التتبع**: كل علاج له مدفوعات محددة ومرتبطة به
4. **مرونة في التعديل**: إمكانية تعديل التكلفة في أي وقت دون مشاكل محاسبية

## ملاحظات مهمة
- يتم تحديث جميع المدفوعات المرتبطة بالعلاج وليس فقط المدفوعات المعلقة
- يتم إعادة حساب الحالات والأرصدة تلقائياً
- لا يتم إنشاء دفعة جديدة إلا إذا لم توجد مدفوعات سابقة وكانت التكلفة أكبر من صفر
